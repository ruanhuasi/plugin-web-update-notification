{"version":3,"sources":["../src/index.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/ban-ts-comment */\r\nimport { accessSync, constants, readFileSync, writeFileSync } from 'fs'\r\nimport { resolve } from 'path'\r\nimport type { Options } from '@plugin-ofs-web-update-notification/core'\r\nimport {\r\n  DIRECTORY_NAME,\r\n  INJECT_SCRIPT_FILE_NAME,\r\n  INJECT_STYLE_FILE_NAME,\r\n  JSON_FILE_NAME,\r\n  NOTIFICATION_ANCHOR_CLASS_NAME,\r\n  generateJSONFileContent,\r\n  generateJsFileContent,\r\n  getFileHash,\r\n  getVersion,\r\n  get__Dirname,\r\n} from '@plugin-ofs-web-update-notification/core'\r\nimport type { Compilation, Compiler } from '@rspack/core'\r\n\r\nconst PLUGIN_NAME = 'WebUpdateNotificationPlugin'\r\n\r\ntype PluginOptions = Options & {\r\n  /** index.html file path, by default, we will look up path.resolve(webpackOutputPath, './index.html') */\r\n  indexHtmlFilePath?: string\r\n}\r\n\r\n/**\r\n * It injects the hash into the HTML, and injects the notification anchor and the stylesheet and the\r\n * script into the HTML\r\n * @param {string} html - The original HTML of the page\r\n * @param {string} version - The hash of the current commit\r\n * @param {Options} options - Options\r\n * @returns The html of the page with the injected script and css.\r\n */\r\nfunction injectPluginHtml(\r\n  html: string,\r\n  version: string,\r\n  options: Options,\r\n  { cssFileHash, jsFileHash }: { jsFileHash: string; cssFileHash: string },\r\n) {\r\n  const { hiddenDefaultNotification, injectFileBase = '/' } = options;\r\n  \r\n  // 注入版本信息\r\n  const versionScript = `<script>window.pluginWebUpdateNotice_version = '${version}';</script>`;\r\n  \r\n  // 注入样式链接\r\n  const cssLinkHtml = hiddenDefaultNotification ? '' : \r\n    `<link rel=\"stylesheet\" href=\"${injectFileBase}${DIRECTORY_NAME}/${INJECT_STYLE_FILE_NAME}.${cssFileHash}.css\">`;\r\n  \r\n  // 注入脚本\r\n  html = html.replace(\r\n    '</head>',\r\n    `${cssLinkHtml}\r\n    <script src=\"${injectFileBase}${DIRECTORY_NAME}/${INJECT_SCRIPT_FILE_NAME}.${jsFileHash}.js\"></script>\r\n    ${versionScript}\r\n    </head>`\r\n  );\r\n  \r\n  // 注入通知容器\r\n  if (!hiddenDefaultNotification) {\r\n    html = html.replace(\r\n      '</body>',\r\n      `<div class=\"${NOTIFICATION_ANCHOR_CLASS_NAME}\"></div></body>`\r\n    );\r\n  }\r\n\r\n  return html\r\n}\r\n\r\nclass WebUpdateNotificationPlugin {\r\n  options: PluginOptions\r\n  constructor(options: PluginOptions) {\r\n    this.options = options || {}\r\n  }\r\n\r\n  apply(compiler: Compiler) {\r\n    /** inject script file hash */\r\n    let jsFileHash = ''\r\n    /** inject css file hash */\r\n    let cssFileHash = ''\r\n\r\n    const { publicPath } = compiler.options.output;\r\n    if (this.options.injectFileBase === undefined) {\r\n      this.options.injectFileBase = \r\n        typeof publicPath === 'string' ? publicPath : '/';\r\n    }\r\n    \r\n    const { hiddenDefaultNotification, versionType, indexHtmlFilePath, customVersion, silence } = this.options\r\n    let version = ''\r\n    \r\n    if (versionType === 'custom')\r\n      version = getVersion(versionType, customVersion!)\r\n    else\r\n      version = getVersion(versionType!)\r\n\r\n    compiler.hooks.emit.tap(PLUGIN_NAME, (compilation: Compilation) => {\r\n      // const outputPath = compiler.outputPath\r\n      const jsonFileContent = generateJSONFileContent(version, silence)\r\n      // @ts-expect-error\r\n      compilation.emitAsset[`${DIRECTORY_NAME}/${JSON_FILE_NAME}.json`] = {\r\n        source: () => jsonFileContent,\r\n        size: () => jsonFileContent.length,\r\n      }\r\n      if (!hiddenDefaultNotification) {\r\n        const injectStyleContent = readFileSync(`${get__Dirname()}/${INJECT_STYLE_FILE_NAME}.css`, 'utf8')\r\n        cssFileHash = getFileHash(injectStyleContent)\r\n\r\n        // @ts-expect-error\r\n        compilation.emitAsset[`${DIRECTORY_NAME}/${INJECT_STYLE_FILE_NAME}.${cssFileHash}.css`] = {\r\n          source: () => injectStyleContent,\r\n          size: () => injectStyleContent.length,\r\n        }\r\n      }\r\n\r\n      const filePath = resolve(`${get__Dirname()}/${INJECT_SCRIPT_FILE_NAME}.js`)\r\n      const injectScriptContent = generateJsFileContent(\r\n        readFileSync(filePath, 'utf8').toString(),\r\n        version,\r\n        this.options,\r\n      )\r\n      jsFileHash = getFileHash(injectScriptContent)\r\n\r\n      // @ts-expect-error\r\n      compilation.emitAsset[`${DIRECTORY_NAME}/${INJECT_SCRIPT_FILE_NAME}.${jsFileHash}.js`] = {\r\n        source: () => injectScriptContent,\r\n        size: () => injectScriptContent.length,\r\n      }\r\n    })\r\n\r\n    compiler.hooks.afterEmit.tap(PLUGIN_NAME, () => {\r\n      const outputPath = compiler.options.output.path || './dist';\r\n      const htmlFilePath = resolve(outputPath as string, indexHtmlFilePath || './index.html');\r\n      \r\n      try {\r\n        accessSync(htmlFilePath, constants.F_OK);\r\n        \r\n        let html = readFileSync(htmlFilePath, 'utf8');\r\n        \r\n        // 注入脚本\r\n        html = injectPluginHtml(\r\n          html,\r\n          version,\r\n          this.options,\r\n          {\r\n            jsFileHash,\r\n            cssFileHash,\r\n          },\r\n        )\r\n        \r\n        writeFileSync(htmlFilePath, html);\r\n      } catch (error) {\r\n        console.error(`${PLUGIN_NAME} failed to inject the plugin into the HTML file. index.html (${htmlFilePath}) not found.`);\r\n      }\r\n    })\r\n  }\r\n}\r\n\r\nexport { WebUpdateNotificationPlugin }\r\n"],"mappings":"AACA,OAAS,cAAAA,EAAY,aAAAC,EAAW,gBAAAC,EAAc,iBAAAC,MAAqB,KACnE,OAAS,WAAAC,MAAe,OAExB,OACE,kBAAAC,EACA,2BAAAC,EACA,0BAAAC,EACA,kBAAAC,EACA,kCAAAC,EACA,2BAAAC,EACA,yBAAAC,EACA,eAAAC,EACA,cAAAC,EACA,gBAAAC,MACK,2CAGP,IAAMC,EAAc,8BAepB,SAASC,EACPC,EACAC,EACAC,EACA,CAAE,YAAAC,EAAa,WAAAC,CAAW,EAC1B,CACA,GAAM,CAAE,0BAAAC,EAA2B,eAAAC,EAAiB,GAAI,EAAIJ,EAGtDK,EAAgB,mDAAmDN,eAGnEO,EAAcH,EAA4B,GAC9C,gCAAgCC,IAAiBlB,KAAkBE,KAA0Ba,UAG/F,OAAAH,EAAOA,EAAK,QACV,UACA,GAAGQ;AAAA,mBACYF,IAAiBlB,KAAkBC,KAA2Be;AAAA,MAC3EG;AAAA,YAEJ,EAGKF,IACHL,EAAOA,EAAK,QACV,UACA,eAAeR,kBACjB,GAGKQ,CACT,CAEA,IAAMS,EAAN,KAAkC,CAEhC,YAAYP,EAAwB,CAClC,KAAK,QAAUA,GAAW,CAAC,CAC7B,CAEA,MAAMQ,EAAoB,CAExB,IAAIN,EAAa,GAEbD,EAAc,GAEZ,CAAE,WAAAQ,CAAW,EAAID,EAAS,QAAQ,OACpC,KAAK,QAAQ,iBAAmB,SAClC,KAAK,QAAQ,eACX,OAAOC,GAAe,SAAWA,EAAa,KAGlD,GAAM,CAAE,0BAAAN,EAA2B,YAAAO,EAAa,kBAAAC,EAAmB,cAAAC,EAAe,QAAAC,CAAQ,EAAI,KAAK,QAC/Fd,EAAU,GAEVW,IAAgB,SAClBX,EAAUL,EAAWgB,EAAaE,CAAc,EAEhDb,EAAUL,EAAWgB,CAAY,EAEnCF,EAAS,MAAM,KAAK,IAAIZ,EAAckB,GAA6B,CAEjE,IAAMC,EAAkBxB,EAAwBQ,EAASc,CAAO,EAMhE,GAJAC,EAAY,UAAU,GAAG5B,KAAkBG,QAAqB,EAAI,CAClE,OAAQ,IAAM0B,EACd,KAAM,IAAMA,EAAgB,MAC9B,EACI,CAACZ,EAA2B,CAC9B,IAAMa,EAAqBjC,EAAa,GAAGY,EAAa,KAAKP,QAA8B,MAAM,EACjGa,EAAcR,EAAYuB,CAAkB,EAG5CF,EAAY,UAAU,GAAG5B,KAAkBE,KAA0Ba,OAAiB,EAAI,CACxF,OAAQ,IAAMe,EACd,KAAM,IAAMA,EAAmB,MACjC,EAGF,IAAMC,EAAWhC,EAAQ,GAAGU,EAAa,KAAKR,MAA4B,EACpE+B,EAAsB1B,EAC1BT,EAAakC,EAAU,MAAM,EAAE,SAAS,EACxClB,EACA,KAAK,OACP,EACAG,EAAaT,EAAYyB,CAAmB,EAG5CJ,EAAY,UAAU,GAAG5B,KAAkBC,KAA2Be,MAAe,EAAI,CACvF,OAAQ,IAAMgB,EACd,KAAM,IAAMA,EAAoB,MAClC,CACF,CAAC,EAEDV,EAAS,MAAM,UAAU,IAAIZ,EAAa,IAAM,CAC9C,IAAMuB,EAAaX,EAAS,QAAQ,OAAO,MAAQ,SAC7CY,EAAenC,EAAQkC,EAAsBR,GAAqB,cAAc,EAEtF,GAAI,CACF9B,EAAWuC,EAActC,EAAU,IAAI,EAEvC,IAAIgB,EAAOf,EAAaqC,EAAc,MAAM,EAG5CtB,EAAOD,EACLC,EACAC,EACA,KAAK,QACL,CACE,WAAAG,EACA,YAAAD,CACF,CACF,EAEAjB,EAAcoC,EAActB,CAAI,CAClC,MAAE,CACA,QAAQ,MAAM,GAAGF,iEAA2EwB,eAA0B,CACxH,CACF,CAAC,CACH,CACF","names":["accessSync","constants","readFileSync","writeFileSync","resolve","DIRECTORY_NAME","INJECT_SCRIPT_FILE_NAME","INJECT_STYLE_FILE_NAME","JSON_FILE_NAME","NOTIFICATION_ANCHOR_CLASS_NAME","generateJSONFileContent","generateJsFileContent","getFileHash","getVersion","get__Dirname","PLUGIN_NAME","injectPluginHtml","html","version","options","cssFileHash","jsFileHash","hiddenDefaultNotification","injectFileBase","versionScript","cssLinkHtml","WebUpdateNotificationPlugin","compiler","publicPath","versionType","indexHtmlFilePath","customVersion","silence","compilation","jsonFileContent","injectStyleContent","filePath","injectScriptContent","outputPath","htmlFilePath"]}